// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

// Make sure your Neon connection string is set in your .env file
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// -------------------------------------------------------------------
// --- SUPPORTING MODELS ---
// -------------------------------------------------------------------

model City {
  id                Int        @id @default(autoincrement())
  name              String     @unique @db.VarChar(50) 
  createdAt         DateTime   @default(now())
  updatedAt         DateTime   @updatedAt

  departingShipments Shipment[] @relation("DepartureCity")
  arrivingShipments  Shipment[] @relation("ArrivalCity")
}

model Agency {
  id          Int        @id @default(autoincrement())
  name        String     @unique @db.VarChar(100)
  shipments   Shipment[]
}

model Vehicle {
  id            Int        @id @default(autoincrement())
  vehicleNumber String     @unique @db.VarChar(50) 
  shipments     Shipment[]
}

model Party {
  id            Int        @id @default(autoincrement())
  name          String     @db.VarChar(100)
  contactInfo   String     @db.VarChar(100)
  opening_balance Decimal  @db.Decimal(10, 2) 
  
  sentShipments     Shipment[] @relation("SenderParty")
  receivedShipments Shipment[] @relation("ReceiverParty")
}

model ItemCatalog {
  id               Int            @id @default(autoincrement())
  item_description String         @unique @db.VarChar(100)
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  
  goodsDetails GoodsDetails[]
}

// -------------------------------------------------------------------
// --- CORE MODELS ---
// -------------------------------------------------------------------

model GoodsDetails {
  good_detail_id Int    @id @default(autoincrement())
  
  shipment_id    String @db.VarChar(50) 
  shipment       Shipment @relation(fields: [shipment_id], references: [register_number], onDelete: Cascade)
  
  item_name_id   Int    
  itemCatalog    ItemCatalog @relation(fields: [item_name_id], references: [id])
  
  quantity       Int    
  charges        Decimal @default(0.00) @db.Decimal(10, 2)
  
  // FIX APPLIED: Added @default(0.00) to allow safe migration on existing rows.
  delivery_charges Decimal @default(0.00) @db.Decimal(10, 2) 
  
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  
  @@map("Goods_Details")
}

model Transaction {
  transaction_id   Int        @id @default(autoincrement()) 
  transaction_date DateTime   @default(now()) @db.Timestamptz(6) 
  
  party_type       String     @db.VarChar(20) 
  party_ref_id     Int        
  
  shipment_id      String     @db.VarChar(50)
  shipment         Shipment   @relation(fields: [shipment_id], references: [register_number])
  
  credit_amount    Decimal    @db.Decimal(10, 2)
  debit_amount     Decimal    @db.Decimal(10, 2)
  description      String?    @db.VarChar(255)
  
  createdAt        DateTime   @default(now())
  updatedAt        DateTime   @updatedAt
  
  @@map("Transactions")
}

model Shipment {
  // Primary Key
  register_number String @id @db.VarChar(50) 
  
  // Unique Bility
  bility_number   String @unique @db.VarChar(50) 

  // Bility Creation Date
  bility_date     DateTime @db.Date 
  
  // --- Foreign Key Fields and Relations ---

  departure_city_id Int
  departureCity     City @relation("DepartureCity", fields: [departure_city_id], references: [id])

  to_city_id        Int?      
  toCity            City?     @relation("ArrivalCity", fields: [to_city_id], references: [id])

  forwarding_agency_id Int
  forwardingAgency  Agency @relation(fields: [forwarding_agency_id], references: [id])

  vehicle_number_id Int
  vehicle           Vehicle @relation(fields: [vehicle_number_id], references: [id])

  sender_id         Int
  sender            Party @relation("SenderParty", fields: [sender_id], references: [id])

  receiver_id       Int
  receiver          Party @relation("ReceiverParty", fields: [receiver_id], references: [id])

  // Walk-in Customer Names
  walk_in_sender_name   String? @db.VarChar(100) 
  walk_in_receiver_name String? @db.VarChar(100) 

  // --- Data Fields ---

  total_charges          Decimal @db.Decimal(10, 2) // Stores the Final Total Bill Amount
  delivery_date          DateTime? @db.Date 
  remarks                String? @db.Text 

  // NEW: Sum of all goods_details delivery_charges
  total_delivery_charges Decimal @default(0.00) @db.Decimal(10, 2) 

  // --- Relations back to other tables ---
  goodsDetails          GoodsDetails[]
  transactions          Transaction[]
  deliveries            Delivery[]

  // --- Auditing Fields ---
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
}

// -------------------------------------------------------------------
// --- DELIVERY MODEL ---
// -------------------------------------------------------------------

model Delivery {
  delivery_id           Int        @id @default(autoincrement())
  
  // Link to shipment
  shipment_id           String     @db.VarChar(50)
  shipment              Shipment   @relation(fields: [shipment_id], references: [register_number])
  
  // Delivery details
  delivery_date         DateTime   @db.Date
  delivery_time         DateTime?  @db.Timestamptz(6)
  
  // Expense tracking
  station_expense       Decimal    @default(0.00) @db.Decimal(10, 2)
  bility_expense        Decimal    @default(0.00) @db.Decimal(10, 2)
  station_labour        Decimal    @default(0.00) @db.Decimal(10, 2)
  cart_labour           Decimal    @default(0.00) @db.Decimal(10, 2)
  total_expenses        Decimal    @default(0.00) @db.Decimal(10, 2)
  
  // Receiver details for delivery confirmation
  receiver_name         String     @db.VarChar(100)
  receiver_phone        String     @db.VarChar(20)
  receiver_cnic         String     @db.VarChar(15)
  receiver_address      String     @db.Text
  
  // Additional notes
  delivery_notes        String?    @db.Text
  
  // Status
  delivery_status       String     @default("DELIVERED") @db.VarChar(20)
  
  // Auditing fields
  createdAt             DateTime   @default(now())
  updatedAt             DateTime   @updatedAt
}